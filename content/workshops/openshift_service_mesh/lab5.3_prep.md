---
title: Security - Auth Policy Prep
workshops: openshift_service_mesh
workshop_weight: 53
layout: lab
---

# Single Sign-On
Login, registration, and role-based authorization is handled via Red Hat SSO (aka Keycloak).
SSO is included as part of OpenShift or any middleware product subscription you have from Red Hat - woot!

## Installation
Because the service mesh will leverage SSO to authenticate users and generate JWT we need to install it. You will install it via Operator into your namespace.

### Customize the Resources
Check out the .yaml files here and customize for your cluster and domain (also you can customize other things like redirect urls, security settings, CORS, etc). Note that we have super relaxed security settings for the demo and they are not recommended to be used like this in production.

### Create an Instance of SSO / Configuration
You can do this CLI or webconsole. If using web console just use the + button at the top then drag'n'drop the file from the steps below.

<blockquote>
<i class="fa fa-terminal"></i> We create a Keycloak instance using a Kubernetes resource:
</blockquote>
```
oc apply -f ./keycloak.yaml
```

Note: your admin username is `admin` and the password is autogenerated. These are in a secret called: `credential-shared-keycloak`

<blockquote>
<i class="fa fa-terminal"></i> We configure via Kubernetes resources to create the realm + roles + clients & users as follows:
</blockquote>
```
oc apply -f ./keycloak-realm.yaml
```

```
oc apply -f ./keycloak-user-1.yaml
```

```
oc apply -f ./keycloak-user-2.yaml
```

### Editing Config with the SSO Web Console
<blockquote>
<i class="fa fa-desktop"></i> Goto the SSO web console and click "Users"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Select the "demo" user and goto "Credentials"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Set or Reset the password to "demo" (make sure the Temporary check box is set to "off")
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Repeat for the user "theterminator" and set the password to "illbeback"
</blockquote>


Now we will create some roles for our users.


<blockquote>
<i class="fa fa-desktop"></i> With the user "theterminator" still selected click "Role Mappings"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Click on the "cool-kids" role to highlight it. And click the "Add selected" button to give the role.
</blockquote>


## Turn off the FAKE_USER flag we had been using for the earlier part of the labs
We had been faking login earlier to test our app without requiring SSO. Now let's get rid of that and redeploy the app_ui service.

<blockquote>
<i class="fa fa-terminal"></i>
Type the following in the CLI:
</blockquote>

```
oc set env dc/app-ui FAKE_USER=false
```

## Access Info / API documentation
- Admin can login at: https://auth-microservices-demo.apps.YOURCLUSTER.COM/
- Users will login at: https://auth-microservices-demo.apps.YOURCLUSTER.COM/auth/realms/microservices/account

To understand more about keycloak check out the resources below:
* [Official Docs][1]
* [Upstream Docs][2]
* [Blog Example][3]

[1]: https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.3/html-single/red_hat_single_sign-on_for_openshift/
[2]: https://www.keycloak.org/documentation.html
[3]: https://developers.redhat.com/blog/2020/01/29/api-login-and-jwt-token-generation-using-keycloak/
